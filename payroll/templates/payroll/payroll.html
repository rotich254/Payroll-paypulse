{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Payroll Processing - PayPulse{% endblock %}

{% block page_title %}Payroll Processing{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<style>
  .nav-tabs .nav-link {
    color: #6c757d;
    border: none;
    padding: 1rem 1.5rem;
    font-weight: 600;
  }
  .nav-tabs .nav-link.active {
    color: #4e73df;
    border-bottom: 2px solid #4e73df;
  }
  .nav-tabs .nav-link:hover {
    border-color: transparent;
    color: #4e73df;
  }
  .tab-content {
    padding-top: 2rem;
  }
  .card {
    border: none;
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
  }
  .table > :not(caption) > * > * {
    padding: 1rem;
  }
  .btn-icon {
    padding: 0.25rem 0.5rem;
    line-height: 1;
  }
  .select2-container--bootstrap-5 .select2-selection {
    min-height: 38px;
  }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-end mb-3">
    <a href="{% url 'paid_payroll_list' %}" class="btn btn-success me-2">
        <i class="bi bi-check-circle me-2"></i>View Paid Payrolls
    </a>
    <a href="{% url 'pending_payroll_list' %}" class="btn btn-warning">
        <i class="bi bi-clock-history me-2"></i>View Pending Payrolls
    </a>
</div>
<div class="tab-content" id="payrollTabsContent">
  <!-- Generate Payroll Tab -->
  <div class="tab-pane fade show active" id="generate" role="tabpanel" aria-labelledby="generate-tab">
    {% include 'payroll/generate_payroll.html' %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
$(document).ready(function() {
    let currentEmployeeData = null;

    // Initialize Select2
    $('#employee').select2({
        theme: 'bootstrap-5',
        width: '100%',
        ajax: {
            url: '{% url "search_employees" %}',
            dataType: 'json',
            delay: 250,
            data: function (params) {
                return {
                    q: params.term // search term
                };
            },
            processResults: function (data) {
                return {
                    results: data.results
                };
            },
            cache: true
        },
        placeholder: 'Search for an employee',
        minimumInputLength: 1,
    });

    const employeeSelect = document.getElementById('employee');
    const grossSalaryInput = document.getElementById('gross_salary');
    const totalAllowancesInput = document.getElementById('total_allowances');
    const totalDeductionsInput = document.getElementById('total_deductions');
    const netSalaryInput = document.getElementById('net_salary');

    totalAllowancesInput.value = '0.00';
    totalDeductionsInput.value = '0.00';


    // Function to format currency
    function formatCurrency(number) {
        return number.toLocaleString('en-KE', {
            style: 'currency',
            currency: 'KES',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }

    // Function to calculate net salary
    function calculateNetSalary(grossSalary, allowances, deductions, taxRate, healthInsurance, retirementRate) {
        // Parse values and ensure they're numbers
        grossSalary = parseFloat(grossSalary) || 0;
        allowances = parseFloat(allowances) || 0;
        deductions = parseFloat(deductions) || 0;
        
        const subtotal = grossSalary + allowances;
        const taxAmount = subtotal * (taxRate / 100);
        const retirementAmount = subtotal * (retirementRate / 100);
        const totalDeductions = deductions + taxAmount + parseFloat(healthInsurance) + retirementAmount;
        
        return Math.max(0, subtotal - totalDeductions);
    }

    // Function to update calculations
    function updateCalculations() {
        if (!currentEmployeeData) return;

        const grossSalary = currentEmployeeData.salary;
        const allowances = parseFloat(totalAllowancesInput.value) || 0;
        const deductions = parseFloat(totalDeductionsInput.value) || 0;
        
        // Set the gross salary with proper formatting
        grossSalaryInput.value = grossSalary.toFixed(2);
        
        // Calculate and set net salary
        const netSalary = calculateNetSalary(
            grossSalary,
            allowances,
            deductions,
            currentEmployeeData.tax_rate,
            currentEmployeeData.health_insurance,
            currentEmployeeData.retirement_rate
        );
        
        // Update display values with proper formatting
        grossSalaryInput.value = grossSalary.toFixed(2);
        netSalaryInput.value = netSalary.toFixed(2);

        // Show calculations breakdown in console for debugging
        console.log({
            grossSalary,
            allowances,
            deductions,
            taxAmount: (grossSalary + allowances) * (currentEmployeeData.tax_rate / 100),
            healthInsurance: currentEmployeeData.health_insurance,
            retirementAmount: (grossSalary + allowances) * (currentEmployeeData.retirement_rate / 100),
            netSalary
        });
    }

    // Handle employee selection
    $(employeeSelect).on('select2:select', function (e) {
        var employeeId = e.params.data.id;
        if (employeeId) {
            // Clear previous values
            totalAllowancesInput.value = '0.00';
            totalDeductionsInput.value = '0.00';
            
            // Fetch employee data from the server
            fetch(`/get-employee-salary/${employeeId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error:', data.error);
                        return;
                    }
                    currentEmployeeData = data;
                    updateCalculations();
                })
                .catch(error => {
                    console.error('Error:', error);
                    // Clear inputs on error
                    grossSalaryInput.value = '';
                    netSalaryInput.value = '';
                });
        } else {
            // Clear all inputs if no employee selected
            currentEmployeeData = null;
            grossSalaryInput.value = '';
            netSalaryInput.value = '';
            totalAllowancesInput.value = '0.00';
            totalDeductionsInput.value = '0.00';
        }
    });

    // Handle real-time updates for allowances and deductions
    [totalAllowancesInput, totalDeductionsInput].forEach(input => {
        input.addEventListener('input', function() {
            // Remove any non-numeric characters except decimal point
            this.value = this.value.replace(/[^\d.-]/g, '');
            
            // Ensure value is not negative
            let value = parseFloat(this.value);
            if (isNaN(value) || value < 0) {
                this.value = '0.00';
            }
            
            if (currentEmployeeData) {
                updateCalculations();
            }
        });

        // Format on blur
        input.addEventListener('blur', function() {
            if (this.value === '' || isNaN(parseFloat(this.value))) {
                this.value = '0.00';
            } else {
                this.value = parseFloat(this.value).toFixed(2);
            }
        });
    });
    
    // Handle payroll form submission
    const payrollForm = document.getElementById('payrollForm');
    if (payrollForm) {
        payrollForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            
            fetch('{% url "generate_payroll" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Show success message
                    alert(data.message);
                    
                    // Redirect to payroll detail page
                    window.location.href = data.data.detail_url;
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while generating payroll');
            });
        });
    }

    // Handle tab state persistence
    var activeTab = localStorage.getItem('activePayrollTab');
    if (activeTab) {
        $(activeTab).tab('show');
    }

    $('button[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
        localStorage.setItem('activePayrollTab', '#' + $(e.target).attr('id'));
    });

    // Form validation
    var forms = document.querySelectorAll('.needs-validation');
    Array.prototype.slice.call(forms).forEach(function (form) {
        form.addEventListener('submit', function (event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        }, false);
    });

    // Date range validation
    $('#start_date').on('change', function() {
        $('#end_date').attr('min', $(this).val());
    });

    $('#end_date').on('change', function() {
        $('#start_date').attr('max', $(this).val());
    });
});
</script>
{% endblock %}
