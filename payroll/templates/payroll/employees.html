{% extends 'base.html' %}
{% load static %}

{% block title %}Employees Management - PayPulse{% endblock %}

{% block page_title %}Employees Management{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/employees.css' %}">
<style>
  .employee-card {
    transition: transform 0.2s;
  }
  .employee-card:hover {
    transform: translateY(-5px);
  }
  .department-filter {
    min-width: 200px;
  }
  .search-box {
    max-width: 300px;
  }
  .table th {
    background-color: #f8f9fa;
    font-weight: 600;
  }
  .avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
  }
  .status-badge {
    padding: 0.35em 0.65em;
    font-size: 0.75em;
    font-weight: 600;
    border-radius: 0.25rem;
  }
  .status-active {
    background-color: #d1e7dd;
    color: #0f5132;
  }
  .status-inactive {
    background-color: #f8d7da;
    color: #842029;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- Alerts -->
  {% if messages %}
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
  {% endif %}

  <!-- Header Section -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h3 class="mb-0">Employee Directory</h3>
      <p class="text-muted mb-0">Manage your workforce efficiently</p>
    </div>
    <a href="{% url 'add_employee' %}" class="btn btn-primary">
      <i class="bi bi-plus-lg me-2"></i>Add Employee
    </a>
  </div>

  <!-- Filters and Search -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <div class="row g-3 align-items-center">
        <div class="col-md-3">
          <select class="form-select department-filter" id="departmentFilter">
            <option value="">All Departments</option>
            {% for code, name in department_choices %}
            <option value="{{ code }}" {% if current_department == code %}selected{% endif %}>{{ name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <select class="form-select" id="statusFilter">
            <option value="">All Status</option>
            {% for code, name in status_choices %}
            <option value="{{ code }}" {% if current_status == code %}selected{% endif %}>
              {{ name }}
              {% with count=status_counts %}
                {% if count %}
                  {% for key, value in count.items %}
                    {% if key == code %}({{ value }}){% endif %}
                  {% endfor %}
                {% endif %}
              {% endwith %}
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-6">
          <div class="input-group position-relative">
            <span class="input-group-text bg-transparent">
              <i class="bi bi-search"></i>
            </span>
            <input type="text" class="form-control" id="searchEmployee" name="search" value="{{ search_query }}" placeholder="Search employees by name or email...">
            <div class="search-loader"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Employee Table -->
  <div class="card shadow-sm">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="card-title mb-0">Employee List</h5>
        <button class="btn btn-sm btn-outline-primary" id="refreshEmployees" title="Refresh Employee List">
          <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
      </div>
      <div class="table-responsive">
        <table class="table table-hover align-middle" id="employeesTable">
          <thead>
            <tr>
              <th>Employee</th>
              <th>Status</th>
              <th>Salary</th>
              <th>Start Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="employeeTableBody">
            {% include 'payroll/partials/employee_table_body.html' %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Pagination Controls -->
  <div class="d-flex justify-content-center mt-4">
    <nav aria-label="Employee pagination">
      <ul class="pagination">
        {% if employees.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page={{ employees.previous_page_number }}{% if current_department %}&department={{ current_department }}{% endif %}{% if current_status %}&status={{ current_status }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}" aria-label="Previous">
              <span aria-hidden="true">&laquo;</span>
            </a>
          </li>
        {% else %}
          <li class="page-item disabled">
            <span class="page-link">&laquo;</span>
          </li>
        {% endif %}
        {% for num in employees.paginator.page_range %}
          {% if employees.number == num %}
            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
          {% elif num > employees.number|add:'-3' and num < employees.number|add:'3' %}
            <li class="page-item"><a class="page-link" href="?page={{ num }}{% if current_department %}&department={{ current_department }}{% endif %}{% if current_status %}&status={{ current_status }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}">{{ num }}</a></li>
          {% endif %}
        {% endfor %}
        {% if employees.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ employees.next_page_number }}{% if current_department %}&department={{ current_department }}{% endif %}{% if current_status %}&status={{ current_status }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}" aria-label="Next">
              <span aria-hidden="true">&raquo;</span>
            </a>
          </li>
        {% else %}
          <li class="page-item disabled">
            <span class="page-link">&raquo;</span>
          </li>
        {% endif %}
      </ul>
    </nav>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirm Delete</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to delete <span id="employeeName"></span>? This action cannot be undone.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <form id="deleteForm" method="POST" action="">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">Delete</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  function confirmDelete(employeeId, employeeName) {
    document.getElementById('employeeName').textContent = employeeName;
    document.getElementById('deleteForm').action = `/payroll/delete_employee/${employeeId}/`;
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
  }

  document.addEventListener('DOMContentLoaded', function () {
    const searchInput = document.getElementById('searchEmployee');
    const departmentFilter = document.getElementById('departmentFilter');
    const statusFilter = document.getElementById('statusFilter');
    const tableBody = document.getElementById('employeeTableBody');
    const refreshBtn = document.getElementById('refreshEmployees');
    const paginationContainer = document.querySelector('.pagination');

    let searchTimeout;

    function fetchEmployees(showLoader = true) {
      // Clear previous timeout
      if (searchTimeout) {
        clearTimeout(searchTimeout);
      }
      
      // Debounce search
      searchTimeout = setTimeout(() => {
        if (showLoader) {
          LoaderUtils.showSearchLoader('searchEmployee');
          LoaderUtils.showTableLoader('employeesTable');
        }
        
      const searchQuery = searchInput.value;
      const department = departmentFilter.value;
      const status = statusFilter.value;
      // Start from page 1 for any new search/filter
      const url = `{% url 'employee_list' %}?search=${searchQuery}&department=${department}&status=${status}&page=1`;

      fetch(url, {
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.text();
        })
      .then(html => {
          LoaderUtils.hideSearchLoader('searchEmployee');
          
          // Animate table update
          tableBody.style.opacity = '0.5';
          setTimeout(() => {
        tableBody.innerHTML = html;
            tableBody.style.opacity = '1';
            
            // Reinitialize any tooltips or interactive elements
            initializeTooltips();
          }, 200);
        })
        .catch(error => {
          console.error('Error fetching employees:', error);
          LoaderUtils.hideSearchLoader('searchEmployee');
          
          // Show error message
          const errorRow = `
            <tr>
              <td colspan="5" class="text-center text-danger py-4">
                <i class="bi bi-exclamation-triangle me-2"></i>
                Error loading employees. Please try again.
              </td>
            </tr>
          `;
          tableBody.innerHTML = errorRow;
        });
      }, 200); // 200ms debounce
    }
    
    function initializeTooltips() {
      // Reinitialize Bootstrap tooltips for new content
      const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
      });
    }
    
    function refreshEmployeeList() {
      LoaderUtils.showButtonLoader(refreshBtn, '<i class="bi bi-arrow-clockwise"></i> Refreshing...');
      LoaderUtils.showTableLoader('employeesTable');
      
      // Reset filters
      searchInput.value = '';
      departmentFilter.value = '';
      statusFilter.value = '';
      
      // Fetch fresh data
      setTimeout(() => {
        fetchEmployees(false);
        LoaderUtils.hideButtonLoader(refreshBtn);
        
        // Show success message
        const successDiv = document.createElement('div');
        successDiv.className = 'alert alert-success alert-dismissible fade show';
        successDiv.innerHTML = `
          <i class="bi bi-check-circle me-2"></i>Employee list refreshed successfully!
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector('.container-fluid').prepend(successDiv);
        
        // Auto-hide after 2 seconds
        setTimeout(() => {
          if (successDiv) {
            successDiv.remove();
          }
        }, 2000);
      }, 300);
    }

    // Event listeners
    searchInput.addEventListener('keyup', () => fetchEmployees());
    departmentFilter.addEventListener('change', () => fetchEmployees());
    statusFilter.addEventListener('change', () => fetchEmployees());
    refreshBtn.addEventListener('click', refreshEmployeeList);
    
    // Initialize tooltips on page load
    initializeTooltips();
    
    // Add status update functionality with loaders
    window.updateEmployeeStatus = function(employeeId, newStatus, button) {
      LoaderUtils.showButtonLoader(button, 'Updating...');
      
      const formData = new FormData();
      formData.append('status', newStatus);
      formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
      
      fetch(`{% url 'update_employee_status' 0 %}`.replace('0', employeeId), {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        LoaderUtils.hideButtonLoader(button);
        
        if (data.status === 'success') {
          // Show success animation
          LoaderUtils.showSuccess(button.parentElement, 'Status updated!');
          
          // Refresh the table to show updated data
          setTimeout(() => {
            fetchEmployees(false);
          }, 800);
        } else {
          // Show error message
          const errorDiv = document.createElement('div');
          errorDiv.className = 'alert alert-danger alert-dismissible fade show';
          errorDiv.innerHTML = `
            <i class="bi bi-exclamation-triangle me-2"></i>Error: ${data.message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          `;
          document.querySelector('.container-fluid').prepend(errorDiv);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        LoaderUtils.hideButtonLoader(button);
        
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-danger alert-dismissible fade show';
        errorDiv.innerHTML = `
          <i class="bi bi-exclamation-triangle me-2"></i>An error occurred while updating status.
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector('.container-fluid').prepend(errorDiv);
      });
    };
  });
</script>
{% endblock %}
